LOCAL_DIR := $(PWD)

ifndef FINS_ROOT_DIR
FINS_ROOT_DIR := $(LOCAL_DIR)/../..
export FINS_ROOT_DIR
endif

# fins.mk contains the compiler and linker options for each target platform
include $(FINS_ROOT_DIR)/settings.finsmk

#Name of the module
PROJECT_NAME = capturer

GLUE_DIR = $(FINS_ROOT_DIR)/trunk/libs/libglue
PCAP_DIR = $(FINS_ROOT_DIR)/trunk/libs/libpcap
CAPTURER_INC += -I$(GLUE_DIR) -I$(PCAP_DIR)
CFLAGS += $(CAPTURER_INC)

OBJS = ethermod.o htoi.o wifistub.o
GLUE_OBJS = $(shell cat $(GLUE_DIR)/OBJS.finsmk)
PCAP_OBJS = $(shell cat $(PCAP_DIR)/OBJS.finsmk)

ifdef BUILD_FOR_ANDROID_ARM
OBJS += $(GLUE_OBJS) $(PCAP_OBJS)
EXTRAS = glue pcap
else
OBJS += $(COMMON_OBJS)
endif

#This is an autogenerated list of includes used in this project
INCLUDES = $(shell ls $(subst -I,, $(CAPTURER_INC)) | grep \\.h)

INSTALL_DIR = /data/local/tmp



#### TARGETS #####
.PHONY:all
all:$(PROJECT_NAME)
	@echo "$(PROJECT_NAME) is compiled\n"

$(PROJECT_NAME):$(OBJS) $(EXTRAS)
	@$(LD) $(LDFLAGS) $^ -o $@ 

%.o:%.c $(INCLUDES) 
	@$(CC) $(CFLAGS) -c $< -o $@

.PHONY:pcap
pcap:
	@cd $(PCAP_DIR); $(MAKE) all; cd $(LOCAL_DIR);

.PHONY:glue
glue:
	@cd $(GLUE_DIR); $(MAKE) all; cd $(LOCAL_DIR);

.PHONY:clean
clean:
ifdef BUILD_FOR_ANDROID_ARM
	@cd $(PCAP_DIR); $(MAKE) clean; cd $(LOCAL_DIR);
endif
	@rm -f $(PROJECT_NAME) 
	@rm -f *.o

.PHONY:install
install: $(PROJECT_NAME)
	@adb push $(PROJECT_NAME) $(INSTALL_DIR)/$(PROJECT_NAME)
	@adb shell chmod 777 $(INSTALL_DIR)/$(PROJECT_NAME)

.PHONY:debug
debug:
	$(GDB_CLIENT) $(PROJECT_NAME)

.PHONY:test
test:
	@echo "LD='$(LD)'"
	@echo "LDFLAGS='$(LDFLAGS)'"
	@echo "CC='$(CC)'"
	@echo "CFLAGS='$(CFLAGS)'"